<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Hong Kong Central Macau Ferry - Solari Board - v0.1</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background-color: black;
      font-family: Arial, sans-serif;
      color: white;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      padding: 10px;
    }

    #scaleContainer {
      width: 100%;
      overflow-x: hidden; /* previously was 'hidden' */
      overflow-y: auto;   /* allow vertical scroll */
      height: 100vh;      /* make sure it fills the viewport height */
    }

    #scalingInner {
      transform-origin: top left;
      display: block; /* change from flex to block */
      padding: 10px;
      position: relative; /* optional: helps with absolute children */
    }

    .displayWrapper {
      position: relative;
      flex-shrink: 0;
      margin-right: var(--gap, 10px);
    }

    .half {
      position: absolute;
      overflow: hidden;
    }

    .upper {
      background-color: #111111;
    }

    .lower {
      background-color: #1A1A1A;
    }

    .half img {
      object-fit: cover;
      display: block;
    }

    .upper img {
      object-position: top;
      transform-origin: top;
    }

    .lower img {
      object-position: bottom;
      transform-origin: bottom;
    }

    .upperNext { z-index: 1; }
    .upperCurrent { z-index: 2; }
    .lowerNext { z-index: 2; }
    .lowerCurrent { z-index: 1; }

    .unitRow {
      position: absolute;
      display: flex;/* key to make children align horizontally */
      left: 0;
    }

    .centerLine {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 10px;
      background-color: black;
      pointer-events: none;
      z-index: 5;
      transform: translateY(-2.5px); /* to vertically center the 5px line */
    }

    /* Tidy up the input area */
    .unitControls {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 6px;
    }
    #pushControls {
      flex-wrap: wrap;
      gap: 4px;
    }
    .orange-btn {
      background-color: orange;
      color: black;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
    }

    select {
      padding: 4px 2px;
      font-size: 12px; /* Optional: smaller font */
      background-color: black;
      color: #777777;
      border: 1px solid #555555;
    }

    button {
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <!--0 AUDIO SUPPORT-->
  <audio id="flipSound" src="sounds/421363__jaszunio15__click_157.wav" preload="auto"></audio>
  <!--1 DISPLAY BLOCK-->
  <div id="scaleContainer">
    <div id="scalingInner"></div>
  </div>
  <!--2 CONTROL BLOCK-->
  <div style="margin-top: 20px; text-align: left;">
    <div id="pushControls" style="margin: 10px; display: flex; flex-wrap: wrap; gap: 10px;">
      <!-- Dropdowns will be injected here -->
      <button onclick="pushInput()" class="orange-btn">Push</button>
    </div>
    <div id="controls">
      <div id="unitControlsWrapper" style="display: flex; flex-direction: column; gap: 4px; padding: 10px;"></div>
      <button onclick="startAllTransitions()" class="orange-btn">Send</button>
    </div>
  </div>

  <script>
    const panelData = {
      Flashing_light: {
        list: [
          ["img/green_wigwag_off.png", "OFF"],
          ["img/green_wigwag_an.gif", "ON"]
        ]
      },
      D01_Carrier: {
        list: [
          ["img/carrier/dFEH.png",    "FEH é æ±æ°´ç¿¼èˆ¹"],
          ["img/carrier/dHMH.png",    "HMH æ¸¯æ¾³é£›ç¿¼èˆ¹"],
          ["img/carrier/dHSF.png",    "HSF å¿«é”è¼ª"],
          ["img/carrier/dSLK.png",    "SLK æµ·è¯èˆ¹å‹™"],
          ["img/null.png",        "----"],
          ["img/carrier/dCMD.png",    "CMD æ‹›å•†èˆ¹å‹™"],
          ["img/null.png",        "----"],
          ["img/carrier/dEAA.png",    "EAA äºžå¤ªèˆªç©º"],
          ["img/null.png",        "----"],
          ["img/carrier/dHKF.png",    "HKF é¦™æ¸¯å°è¼ª"],
          ["img/null.png",        "----"],
          ["img/null.png",        "----"],
          ["img/null.png",        "----"],
          ["img/null.png",        "----"],
          ["img/carrier/dTC.png",     "Turbo Cat æ¸¯æ¾³é£›èˆªèˆ¹"],
          ["img/null.png",        "----"],
          ["img/carrier/dCKS.png",    "CKS ç æ±Ÿèˆ¹å‹™"],
          ["img/null.png",        "----"],
          ["img/carrier/dTURBOJET.png", "TurboJet å™´å°„é£›èˆª"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/carrier/dSTS.png",    "STS ä¿¡å¾·èˆ¹å‹™"]
        ]
      },
      D02_Vovage1: {
        list: [
          ["img/null.png",    "----"],
          ["img/hour/0.png",  "0"],
          ["img/hour/1.png",  "1"],
          ["img/hour/2.png",  "2"],
          ["img/hour/3.png",  "3"],
          ["img/hour/4.png",  "4"],
          ["img/hour/5.png",  "5"],
          ["img/hour/6.png",  "6"],
          ["img/hour/7.png",  "7"],
          ["img/hour/8.png",  "8"],
          ["img/hour/9.png",  "9"],
          ["img/hour/A.png",  "A"],
          ["img/hour/B.png",  "B"],
          ["img/hour/C.png",  "C"],
          ["img/hour/D.png",  "D"],
          ["img/hour/E.png",  "E"],
          ["img/hour/F.png",  "F"],
          ["img/hour/G.png",  "G"],
          ["img/hour/H.png",  "H"],
          ["img/hour/I.png",  "I"],
          ["img/hour/J.png",  "J"],
          ["img/hour/K.png",  "K"],
          ["img/hour/L.png",  "L"],
          ["img/hour/M.png",  "M"],
          ["img/hour/N.png",  "N"],
          ["img/hour/O.png",  "O"],
          ["img/hour/P.png",  "P"],
          ["img/hour/Q.png",  "Q"],
          ["img/hour/R.png",  "R"],
          ["img/hour/S.png",  "S"],
          ["img/hour/T.png",  "T"],
          ["img/hour/U.png",  "U"],
          ["img/hour/V.png",  "V"],
          ["img/hour/W.png",  "W"],
          ["img/hour/X.png",  "X"],
          ["img/hour/Y.png",  "Y"],
          ["img/hour/Z.png",  "Z"],
          ["img/hour/dash.png", "-"],
          ["img/hour/dot.png",  "."],
          ["img/hour/slash.png",  "/"]
        ]
      },
      D07_Destination: {
        list: [
          ["img/destination/tMacau.png",  "MACAU æ¾³é–€"],
          ["img/destination/tShekou.png", "SHEKOU è›‡å£"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/destination/tZhuhai.png", "ZHU HAI ç æµ·"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/destination/tZhongshan.png",  "ZHONGSHAN ä¸­å±±"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/destination/tShenzhen.png", "SHENZHEN æ·±åœ³"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"]
        ]
      },
      D08_Status: {
        list: [
          ["img/null.png",  "----"],
          ["img/bstatus/bBoarding.png",   "é€Ÿå…¥é–˜"],
          ["img/bstatus/bCancelled.png",  "å·²å–æ¶ˆ"],
          ["img/bstatus/bDelayed.png",    "å»¶é²"],
          ["img/bstatus/bBoardingSoon.png",   "å°‡å…¥é–˜"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"]
        ]
      },
      D09_TimeHH: {
        list: [
          ["img/null.png",    "----"],
          ["img/hh/hrs_0.png", "HH 0"],
          ["img/hh/hrs_1.png", "HH 1"],
          ["img/hh/hrs_2.png", "HH 2"],
          ["img/hh/hrs_3.png", "HH 3"],
          ["img/hh/hrs_4.png", "HH 4"],
          ["img/hh/hrs_5.png", "HH 5"],
          ["img/hh/hrs_6.png", "HH 6"],
          ["img/hh/hrs_7.png", "HH 7"],
          ["img/hh/hrs_8.png", "HH 8"],
          ["img/hh/hrs_9.png", "HH 9"],
          ["img/hh/hrs_10.png", "HH 10"],
          ["img/hh/hrs_11.png", "HH 11"],
          ["img/hh/hrs_12.png", "HH 12"],
          ["img/hh/hrs_13.png", "HH 13"],
          ["img/hh/hrs_14.png", "HH 14"],
          ["img/hh/hrs_15.png", "HH 15"],
          ["img/hh/hrs_16.png", "HH 16"],
          ["img/hh/hrs_17.png", "HH 17"],
          ["img/hh/hrs_18.png", "HH 18"],
          ["img/hh/hrs_19.png", "HH 19"],
          ["img/hh/hrs_20.png", "HH 20"],
          ["img/hh/hrs_21.png", "HH 21"],
          ["img/hh/hrs_22.png", "HH 22"],
          ["img/hh/hrs_23.png", "HH 23"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"]
        ]
      },
      D13_RetimeHH: {
        list: [
          ["img/null.png",    "----"],
          ["img/hh/hrs_0.png", "HH 0"],
          ["img/hh/hrs_1.png", "HH 1"],
          ["img/hh/hrs_2.png", "HH 2"],
          ["img/hh/hrs_3.png", "HH 3"],
          ["img/hh/hrs_4.png", "HH 4"],
          ["img/hh/hrs_5.png", "HH 5"],
          ["img/hh/hrs_6.png", "HH 6"],
          ["img/hh/hrs_7.png", "HH 7"],
          ["img/hh/hrs_8.png", "HH 8"],
          ["img/hh/hrs_9.png", "HH 9"],
          ["img/hh/hrs_10.png", "HH 10"],
          ["img/hh/hrs_11.png", "HH 11"],
          ["img/hh/hrs_12.png", "HH 12"],
          ["img/hh/hrs_13.png", "HH 13"],
          ["img/hh/hrs_14.png", "HH 14"],
          ["img/hh/hrs_15.png", "HH 15"],
          ["img/hh/hrs_16.png", "HH 16"],
          ["img/hh/hrs_17.png", "HH 17"],
          ["img/hh/hrs_18.png", "HH 18"],
          ["img/hh/hrs_19.png", "HH 19"],
          ["img/hh/hrs_20.png", "HH 20"],
          ["img/hh/hrs_21.png", "HH 21"],
          ["img/hh/hrs_22.png", "HH 22"],
          ["img/hh/hrs_23.png", "HH 23"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"]
        ]
      },
      D17_Gate: {
        list: [
          ["img/null.png",    "----"],
          ["img/gate/gate_1.png", "Gate 1"],
          ["img/gate/gate_2.png", "Gate 2"],
          ["img/gate/gate_3.png", "Gate 3"],
          ["img/gate/gate_4.png", "Gate 4"],
          ["img/gate/gate_5.png", "Gate 5"],
          ["img/gate/gate_6.png", "Gate 6"],
          ["img/gate/gate_7.png", "Gate 7"],
          ["img/gate/gate_8.png", "Gate 8"],
          ["img/gate/gate_9.png", "Gate 9"],
          ["img/gate/gate_10.png", "Gate 10"],
          ["img/gate/gate_11.png", "Gate 11"],
          ["img/gate/gate_12.png", "Gate 12"],
          ["img/gate/gate_13.png", "Gate 13"],
          ["img/gate/gate_14.png", "Gate 14"],
          ["img/gate/gate_15.png", "Gate 15"],
          ["img/gate/gate_16.png", "Gate 16"],
          ["img/gate/gate_17.png", "Gate 17"],
          ["img/gate/gate_18.png", "Gate 18"],
          ["img/gate/gate_19.png", "Gate 19"],
          ["img/gate/gate_20.png", "Gate 20"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"],
          ["img/null.png",  "----"]
        ]
      }
    };
    // Shared keys using same list
    [
      "D03_Vovage2", "D04_Vovage3", "D05_Vovage4", "D06_Vovage5",
      "D11_Time3", "D12_Time4", "D15_Retime3", "D16_Retime4"
    ].forEach(name => {
      panelData[name] = panelData.D02_Vovage1;
    });

    function createDisplay(config, parent = document.getElementById('scalingInner')) {
      const { name, width, height, gap = 10, defaultImage = panelData[name]?.list?.[0]?.[0] || 'img/null.png' } = config;

      const container = document.createElement('div');
      container.className = 'displayWrapper';
      container.style.setProperty('--gap', `${gap}px`);
      container.style.width = `${width}px`;
      container.style.height = `${height}px`;
      parent.appendChild(container);

      // Flashing lights: render but skip dropdown + transition
      if (name.startsWith("Flashing_light")) {
        const img = document.createElement('img');
        img.src = defaultImage;
        img.style.width = `${width}px`;
        img.style.height = `${height}px`;
        container.appendChild(img);

        // Store flashing light img element for external update
        window[`flashingImg_${name}`] = img;
        return;
      }

      const halfHeight = height / 2;
      const displayId = name;
      const html = `
        <div style="position: relative; width: ${width}px; height: ${height}px; overflow: hidden;">
          <div class="half upper upperNext" id="${displayId}_upperNext" style="width:${width}px; height:${halfHeight}px; bottom:${halfHeight}px;"><img src="${defaultImage}" style="width:${width}px; height:${halfHeight}px;"></div>
          <div class="half upper upperCurrent" id="${displayId}_upperCurrent" style="width:${width}px; height:${halfHeight}px; bottom:${halfHeight}px;"><img src="${defaultImage}" style="width:${width}px; height:${halfHeight}px;"></div>
          <div class="half lower lowerCurrent" id="${displayId}_lowerCurrent" style="width:${width}px; height:${halfHeight}px; top:${halfHeight}px;"><img src="${defaultImage}" style="width:${width}px; height:${halfHeight}px;"></div>
          <div class="half lower lowerNext" id="${displayId}_lowerNext" style="width:${width}px; height:${halfHeight}px; top:${halfHeight}px;"><img src="${defaultImage}" style="width:${width}px; height:${halfHeight}px;"></div>
          <div class="centerLine"></div>
          <div id="${displayId}_gapBar" style="position: absolute; top: ${halfHeight}px; width: ${width}px; height: 6px; background-color: black;"></div>
        </div>
      `;
      container.innerHTML = html;

      // Create dropdown
      const selector = document.createElement('select');
      selector.id = `${name}_selector`;
      (panelData[name]?.list || []).forEach(([src, label]) => {
        const opt = document.createElement('option');
        opt.value = src;
        opt.textContent = label;
        selector.appendChild(opt);
      });

      //Seperate dropdown to new lines, replacing:
      //document.getElementById('controls').insertBefore(selector, document.querySelector('#controls button'));
      let unitIndex = parseInt(name.split("_").pop(), 10);
      let unitControlDiv = document.getElementById(`unitControls_${unitIndex}`);
      if (!unitControlDiv) {
        unitControlDiv = document.createElement("div");
        unitControlDiv.id = `unitControls_${unitIndex}`;
        unitControlDiv.className = "unitControls";
        document.getElementById("unitControlsWrapper").appendChild(unitControlDiv);
      }
      unitControlDiv.appendChild(selector);


      let currentImage = defaultImage;
      const options = (panelData[name]?.list || []).map(([src]) => src);

      // Flip transition + special logic for D08_Status
      window[`startTransition_${name}`] = function () {
        const selectedImage = selector.value;
        if (selectedImage === currentImage) return;

        const currentIndex = options.indexOf(currentImage);
        const targetIndex = options.indexOf(selectedImage);
        if (targetIndex === -1) return;

        const path = [];
        let i = currentIndex;
        do {
          i = (i + 1) % options.length;
          path.push(options[i]);
        } while (i !== targetIndex);

        let index = 0;
        const animateNext = () => {
          if (index >= path.length) return;
          runSingleTransition(path[index++], animateNext);
        };
        animateNext();

        // ðŸŸ¡ Special logic: update flashing lights if this is D08_Status
        if (name.startsWith("D08_Status_")) {
          const unitIndex = name.split("_").pop();
          const isBoarding = selectedImage === "img/bstatus/bBoarding.png";
          const flashSrc = isBoarding ? "img/green_wigwag_an.gif" : "img/green_wigwag_off.png";

          const leftImg = window[`flashingImg_Flashing_light_left_${unitIndex}`];
          const rightImg = window[`flashingImg_Flashing_light_right_${unitIndex}`];
          if (leftImg) leftImg.src = flashSrc;
          if (rightImg) rightImg.src = flashSrc;
        }
      };

      function runSingleTransition(nextImage, callback) {
        function maybePlayFlipSound() {//SOUND!!FOR FUN ONLY DUNNO IF OK
          const audio = document.getElementById("flipSound");
          if (audio && Math.random() < 1) { // 60% chance
            audio.currentTime = 0;
            audio.play();
          }
        }
        const upperCurrent = container.querySelector(`#${name}_upperCurrent`);
        const lowerCurrent = container.querySelector(`#${name}_lowerCurrent`);
        const upperNext = container.querySelector(`#${name}_upperNext`);
        const lowerNext = container.querySelector(`#${name}_lowerNext`);

        const upperCurrentImg = upperCurrent.querySelector('img');
        const lowerCurrentImg = lowerCurrent.querySelector('img');
        const upperNextImg = upperNext.querySelector('img');
        const lowerNextImg = lowerNext.querySelector('img');

        upperCurrentImg.src = currentImage;
        lowerCurrentImg.src = currentImage;
        upperNextImg.src = nextImage;
        lowerNextImg.src = nextImage;
        maybePlayFlipSound(); //SOUND!!FOR FUN ONLY DUNNO IF OK

        upperCurrent.style.transition = 'none';
        upperCurrentImg.style.transition = 'none';
        lowerNext.style.transition = 'none';
        lowerNextImg.style.transition = 'none';

        upperCurrent.style.height = `${halfHeight}px`;
        upperCurrentImg.style.height = `${halfHeight}px`;
        lowerNext.style.height = '0px';
        lowerNextImg.style.height = '0px';

        void upperCurrent.offsetHeight;

        upperCurrent.style.transition = 'height 0.5s';
        upperCurrentImg.style.transition = 'height 0.5s';
        lowerNext.style.transition = 'height 0.5s';
        lowerNextImg.style.transition = 'height 0.5s';

        setTimeout(() => {
          upperCurrent.style.height = '0px';
          upperCurrentImg.style.height = '0px';

          setTimeout(() => {
            lowerNext.style.backgroundColor = '#222222';
            setTimeout(() => {
              lowerNext.style.backgroundColor = '#111111';
            }, 200);

            lowerNext.style.height = `${halfHeight}px`;
            lowerNextImg.style.height = `${halfHeight}px`;

            setTimeout(() => {
              currentImage = nextImage;
              upperCurrentImg.src = currentImage;
              lowerCurrentImg.src = currentImage;
              upperNextImg.src = currentImage;
              lowerNextImg.src = currentImage;
              if (callback) callback();
            }, 100);//Best is 100,20,0
          }, 20);
        }, 0);
      }
    }
    //-----------------------------------------------------------------------------------------------------------------------------------
    //-----------------------------------------------------------------------------------------------------------------------------------

    function startAllTransitions() {
      //staggered delay included here
      /*for (let i = 0; i < unitCount; i++) {
        Object.keys(panelData).forEach(key => {
          const fullName = `${key}_${i}`;
          const fn = window[`startTransition_${fullName}`];
          if (typeof fn === 'function') fn();
        });*/
      const staggerDelay = 20; // milliseconds between each panel's start
        let delayIndex = 0;

        for (let i = 0; i < unitCount; i++) {
          const keys = [
            "D01_Carrier", "D02_Vovage1", "D03_Vovage2", "D04_Vovage3", "D05_Vovage4",
            "D06_Vovage5", "D07_Destination", "D08_Status", "D09_TimeHH",
            "D11_Time3", "D12_Time4", "D13_RetimeHH", "D15_Retime3",
            "D16_Retime4", "D17_Gate"
          ];

          keys.forEach(key => {
            const fullName = `${key}_${i}`;
            const fn = window[`startTransition_${fullName}`];
            if (typeof fn === 'function') {
              const myDelay = delayIndex * staggerDelay;
              delayIndex++;

              setTimeout(() => {
                requestAnimationFrame(fn);
              }, myDelay);
            }
          });

        // Flashing light ON only if status is BOARDING
        const statusSelector = document.getElementById(`D08_Status_${i}_selector`);
        const selectedStatus = statusSelector?.value;
        const shouldFlash = selectedStatus === "img/bstatus/bBoarding.png";

        ["Flashing_light_left", "Flashing_light_right"].forEach(base => {
          const name = `${base}_${i}`;
          const container = document.querySelector(`.displayWrapper:has([id^="${name}_upperCurrent"])`);
          if (container) {
            const upperImg = container.querySelector(`#${name}_upperCurrent img`);
            const lowerImg = container.querySelector(`#${name}_lowerCurrent img`);
            const nextUpper = container.querySelector(`#${name}_upperNext img`);
            const nextLower = container.querySelector(`#${name}_lowerNext img`);
            [upperImg, lowerImg, nextUpper, nextLower].forEach(img => {
              if (img) img.src = shouldFlash ? "img/green_wigwag_an.gif" : "img/green_wigwag_off.png";
            });
          }
        });
      }
    }

    //-----------------------------------------------------------------------------------------------------------------------------------
    //-----------------------------------------------------------------------------------------------------------------------------------

    function createHeaderRow() {
      const headerRow = document.createElement('div');
      headerRow.className = 'unitRow';
      headerRow.style.position = 'absolute';
      headerRow.style.top = '0px';
      headerRow.style.left = '0';

      const headers = [
        { name: "Padding", width: 450, height: 1200, gap: 0, defaultImage: "img/null.png" },
        { name: "ShippingCompany", width: 3265, height: 1200, gap: 700, defaultImage: "img/headers/h1ShippingCo_L.png" },
        { name: "Destination", width: 1134, height: 1200, gap: 380, defaultImage: "img/headers/h2Destination_L.png" },
        { name: "StatusInfo", width: 1924, height: 1200, gap: 520, defaultImage: "img/headers/h4Information_L.png" },
        { name: "Scheduled", width: 882, height: 1200, gap: 400, defaultImage: "img/headers/h5Scheduled_L.png" },
        { name: "Departures", width: 1730, height: 1200, gap: 100, defaultImage: "img/headers/h6Departure_L.png" }
      ];

      headers.forEach(config => {
        const wrapper = document.createElement('div');
        wrapper.className = 'displayWrapper';
        wrapper.style.setProperty('--gap', `${config.gap}px`);
        wrapper.style.width = `${config.width}px`;
        wrapper.style.height = `${config.height}px`;

        const img = document.createElement('img');
        img.src = config.defaultImage;
        img.style.width = `${config.width}px`;
        img.style.height = `${config.height}px`;

        wrapper.appendChild(img);
        headerRow.appendChild(wrapper);
      });

      document.getElementById('scalingInner').appendChild(headerRow);
    }

    //------
    //------

    function createDisplayUnit(unitIndex, verticalGap) {
      const unitContainer = document.createElement('div');
      unitContainer.className = 'unitRow';
      unitContainer.style.position = 'absolute';
      const headerOffset = 1450; // height of header row
      unitContainer.style.top = `${headerOffset + unitIndex * verticalGap}px`;
      unitContainer.style.left = '0';

      const displays = [
        { name: `Flashing_light_left_${unitIndex}`, width: 800, height: 300, gap: 100, defaultImage: "img/green_wigwag_off.png" },
        { name: `D01_Carrier_${unitIndex}`, width: 1700, height: 300, gap: 350 },
        { name: `D02_Vovage1_${unitIndex}`, width: 221, height: 300, gap: 20 },
        { name: `D03_Vovage2_${unitIndex}`, width: 221, height: 300, gap: 20 },
        { name: `D04_Vovage3_${unitIndex}`, width: 221, height: 300, gap: 20 },
        { name: `D05_Vovage4_${unitIndex}`, width: 221, height: 300, gap: 20 },
        { name: `D06_Vovage5_${unitIndex}`, width: 221, height: 300, gap: 350 },
        { name: `D07_Destination_${unitIndex}`, width: 1500, height: 300, gap: 350 },
        { name: `D08_Status_${unitIndex}`, width: 1700, height: 300, gap: 350 },
        { name: `D09_TimeHH_${unitIndex}`, width: 500, height: 300, gap: 20 },
        { name: `D11_Time3_${unitIndex}`, width: 221, height: 300, gap: 10 },
        { name: `D12_Time4_${unitIndex}`, width: 221, height: 300, gap: 350 },
        { name: `D13_RetimeHH_${unitIndex}`, width: 500, height: 300, gap: 20 },
        { name: `D15_Retime3_${unitIndex}`, width: 221, height: 300, gap: 10 },
        { name: `D16_Retime4_${unitIndex}`, width: 221, height: 300, gap: 250 },
        { name: `D17_Gate_${unitIndex}`, width: 385, height: 300, gap: 100 },
        { name: `Flashing_light_right_${unitIndex}`, width: 800, height: 300, gap: 0, defaultImage: "img/green_wigwag_off.png" }
      ];

      displays.forEach(d => {
        createDisplay(d, unitContainer);
      });

      document.getElementById('scalingInner').appendChild(unitContainer); //

    }
    //-----------------------------------------------------------------------------------------------------------------------------------
    //-----------------------------------------------------------------------------------------------------------------------------------

    //displays.forEach(display => createDisplay(display));
    const unitCount = 12; // You can set this dynamically
    const sharedCloneKeys = [
      "D03_Vovage2", "D04_Vovage3", "D05_Vovage4", "D06_Vovage5",
      "D11_Time3", "D12_Time4", "D15_Retime3", "D16_Retime4"
    ];

    // Clone panel data for each unit
    for (let i = 0; i < unitCount; i++) {
      for (const key in panelData) {
        panelData[`${key}_${i}`] = { list: panelData[key].list };
      }
      // Also clone aliases like how you did originally
      sharedCloneKeys.forEach(name => {
        panelData[`${name}_${i}`] = panelData[`D02_Vovage1_${i}`];
      });
    }
    const verticalGap = 520; // Suggested: 300 height + 50 spacing
    createHeaderRow();
    for (let i = 0; i < unitCount; i++) {
      createDisplayUnit(i, verticalGap);
    }
    //-----------------------------------------------------------------------------------------------------------------------------------
    //-----------------------------------------------------------------------------------------------------------------------------------

    function applyScaling() {
      const container = document.getElementById('scaleContainer');
      const inner = document.getElementById('scalingInner');
      const totalWidth = inner.scrollWidth;
      const scale = container.offsetWidth / totalWidth;
      inner.style.transform = `scale(${scale})`;
    }

    window.addEventListener('load', applyScaling);
    window.addEventListener('resize', applyScaling);

    //NEW PUSH FEATURE v0.9
    let pushCount = 0;

    const pushKeys = [
      "D01_Carrier", "D02_Vovage1", "D03_Vovage2", "D04_Vovage3", "D05_Vovage4",
      "D06_Vovage5", "D07_Destination", "D08_Status", "D09_TimeHH",
      "D11_Time3", "D12_Time4", "D13_RetimeHH", "D15_Retime3", "D16_Retime4", "D17_Gate"
    ];

    const pushDropdowns = {};
    const pushControlsDiv = document.getElementById("pushControls");

    pushKeys.forEach(key => {
      const sel = document.createElement("select");
      sel.id = `push_${key}`;
      panelData[key]?.list.forEach(([src, label], i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.textContent = label;
        sel.appendChild(opt);
      });
      pushControlsDiv.appendChild(sel);
      pushDropdowns[key] = sel;
    });

    function pushInput() {
      const selectedIndexes = pushKeys.map(key => parseInt(pushDropdowns[key].value));
      if (pushCount < unitCount) {
        // Apply to next available row
        applyPushDataToRow(pushCount, selectedIndexes);
        startTransitionForRow(pushCount);
        pushCount++;
      } else {
        // Perform queue shift
        shiftUnitsUp(() => {
          applyPushDataToRow(unitCount - 1, selectedIndexes);
          startTransitionForRow(unitCount - 1);
        });
      }
    }

    function applyPushDataToRow(rowIndex, values) {
      pushKeys.forEach((key, colIndex) => {
        const selectorId = `${key}_${rowIndex}_selector`;
        const dropdown = document.getElementById(selectorId);
        if (dropdown) dropdown.selectedIndex = values[colIndex];
      });
    }

    function startTransitionForRow(rowIndex) {
      pushKeys.forEach(key => {
        const fn = window[`startTransition_${key}_${rowIndex}`];
        if (typeof fn === 'function') fn();
      });
    }

    function shiftUnitsUp(callback) {
      let i = 0;

      function shiftNext() {
        if (i >= unitCount - 1) {
          callback();
          return;
        }

        // Copy data from row i+1 to row i
        pushKeys.forEach(key => {
          const from = document.getElementById(`${key}_${i + 1}_selector`);
          const to = document.getElementById(`${key}_${i}_selector`);
          if (from && to) to.selectedIndex = from.selectedIndex;
        });

        // Start transition and then wait for it to complete
        startTransitionForRow(i);

        // Wait ~600ms for transition + 2 seconds before next
        setTimeout(() => {
          i++;
          shiftNext();
        }, 4600); // 600ms transition + 2000ms delay
      }

      shiftNext();
    }
    //END OF NEW PUSH FEATURE v0.9

  </script>

</body>
</html>
